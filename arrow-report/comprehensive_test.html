<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Arrow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #plot { width: 100%; height: 400px; border: 1px solid #ddd; margin: 10px 0; }
        #console { white-space: pre-wrap; background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-item { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Comprehensive Arrow File Test Suite</h1>
    
    <div class="test">
        <h2>Step 1: Library Loading Test</h2>
        <button onclick="testLibraries()">Test All Libraries</button>
        <div id="libraryResults"></div>
    </div>
    
    <div class="test">
        <h2>Step 2: Arrow API Test</h2>
        <button onclick="testArrowAPI()">Test Arrow API Methods</button>
        <div id="apiResults"></div>
    </div>
    
    <div class="test">
        <h2>Step 3: File Loading & Parsing Test</h2>
        <input type="file" id="fileInput" accept=".arrow" />
        <button onclick="testFileParsing()">Test File Parsing</button>
        <div id="fileResults"></div>
    </div>
    
    <div class="test">
        <h2>Step 4: Data Analysis Test</h2>
        <button onclick="testDataAnalysis()" id="analysisBtn" disabled>Analyze Data</button>
        <div id="analysisResults"></div>
    </div>
    
    <div class="test">
        <h2>Step 5: Plotting Test</h2>
        <button onclick="testPlotting()" id="plotBtn" disabled>Create Plots</button>
        <div id="plotResults"></div>
        <div id="plot"></div>
    </div>
    
    <div class="test">
        <h2>Step 6: Performance Test</h2>
        <button onclick="testPerformance()" id="perfBtn" disabled>Run Performance Test</button>
        <div id="perfResults"></div>
    </div>
    
    <div class="test">
        <h2>Console Output</h2>
        <div id="console"></div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@21.0.0/Arrow.es2015.min.js"></script>
    <script src="https://unpkg.com/arquero@5.3.0/dist/arquero.min.js"></script>
    <script src="https://unpkg.com/@observablehq/plot@0.6.17/dist/plot.umd.min.js"></script>
    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>

    <script>
        let parsedData = null;
        let parsedTable = null;
        
        // Console capture
        const originalLog = console.log;
        const originalError = console.error;
        const consoleDiv = document.getElementById('console');
        
        function log(message) {
            originalLog(message);
            consoleDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function error(message) {
            originalError(message);
            consoleDiv.textContent += new Date().toLocaleTimeString() + ': ERROR: ' + message + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = log;
        console.error = error;
        
        function testLibraries() {
            const results = document.getElementById('libraryResults');
            results.innerHTML = '<p>Testing library loading...</p>';
            
            try {
                const libraries = {
                    'Apache Arrow': typeof Arrow !== 'undefined',
                    'Arquero': typeof aq !== 'undefined',
                    'Observable Plot': typeof Plot !== 'undefined',
                    'D3': typeof d3 !== 'undefined'
                };
                
                log('Testing library availability...');
                Object.entries(libraries).forEach(([name, loaded]) => {
                    log(`${name}: ${loaded ? '✅ Loaded' : '❌ Not loaded'}`);
                });
                
                const failed = Object.entries(libraries).filter(([name, loaded]) => !loaded);
                
                if (failed.length === 0) {
                    results.innerHTML = '<div class="success">✅ All libraries loaded successfully!</div>';
                    log('All libraries loaded successfully');
                } else {
                    results.innerHTML = `<div class="error">❌ Failed to load: ${failed.map(([name]) => name).join(', ')}</div>`;
                    log(`Failed to load: ${failed.map(([name]) => name).join(', ')}`);
                }
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Library loading test failed: ${error.message}</div>`;
                error(`Library loading test failed: ${error.message}`);
            }
        }
        
        function testArrowAPI() {
            const results = document.getElementById('apiResults');
            results.innerHTML = '<p>Testing Arrow API...</p>';
            
            try {
                const apiTests = [];
                
                // Test Arrow.Table
                if (typeof Arrow.Table !== 'undefined') {
                    apiTests.push('Arrow.Table ✓');
                    log('Arrow.Table available');
                } else {
                    apiTests.push('Arrow.Table ✗');
                    log('Arrow.Table not available');
                }
                
                // Test Arrow.Table.from
                if (typeof Arrow.Table.from === 'function') {
                    apiTests.push('Arrow.Table.from ✓');
                    log('Arrow.Table.from available');
                } else {
                    apiTests.push('Arrow.Table.from ✗');
                    log('Arrow.Table.from not available');
                }
                
                // Test Arrow.tableFrom
                if (typeof Arrow.tableFrom === 'function') {
                    apiTests.push('Arrow.tableFrom ✓');
                    log('Arrow.tableFrom available');
                } else {
                    apiTests.push('Arrow.tableFrom ✗');
                    log('Arrow.tableFrom not available');
                }
                
                // Test Arrow.read
                if (typeof Arrow.read === 'function') {
                    apiTests.push('Arrow.read ✓');
                    log('Arrow.read available');
                } else {
                    apiTests.push('Arrow.read ✗');
                    log('Arrow.read not available');
                }
                
                // Test Arrow.RecordBatchReader
                if (typeof Arrow.RecordBatchReader !== 'undefined') {
                    apiTests.push('Arrow.RecordBatchReader ✓');
                    log('Arrow.RecordBatchReader available');
                } else {
                    apiTests.push('Arrow.RecordBatchReader ✗');
                    log('Arrow.RecordBatchReader not available');
                }
                
                const failed = apiTests.filter(test => test.includes('✗'));
                
                if (failed.length === 0) {
                    results.innerHTML = '<div class="success">✅ All Arrow API methods available!</div>';
                    log('All Arrow API methods available');
                } else {
                    results.innerHTML = `<div class="warning">⚠️ Missing API methods: ${failed.join(', ')}</div>`;
                    log(`Missing API methods: ${failed.join(', ')}`);
                }
                
                log('Arrow API tests: ' + apiTests.join(', '));
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Arrow API test failed: ${error.message}</div>`;
                error(`Arrow API test failed: ${error.message}`);
            }
        }
        
        function testFileParsing() {
            const fileInput = document.getElementById('fileInput');
            const results = document.getElementById('fileResults');
            
            if (fileInput.files.length === 0) {
                results.innerHTML = '<div class="error">Please select a file first</div>';
                return;
            }
            
            const file = fileInput.files[0];
            results.innerHTML = `<p>Testing file: ${file.name} (${file.size} bytes)</p>`;
            log(`Testing file: ${file.name} (${file.size} bytes)`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                log(`File loaded, size: ${arrayBuffer.byteLength} bytes`);
                
                try {
                    const uint8Array = new Uint8Array(arrayBuffer);
                    log(`First 32 bytes: [${Array.from(uint8Array.slice(0, 32)).join(', ')}]`);
                    
                    // Try parsing with different methods
                    let table;
                    let method = '';
                    
                    if (typeof Arrow.Table !== 'undefined' && typeof Arrow.Table.from === 'function') {
                        table = Arrow.Table.from(uint8Array);
                        method = 'Arrow.Table.from';
                        log('Parsed with Arrow.Table.from');
                    } else if (typeof Arrow.tableFrom === 'function') {
                        table = Arrow.tableFrom(uint8Array);
                        method = 'Arrow.tableFrom';
                        log('Parsed with Arrow.tableFrom');
                    } else if (typeof Arrow.read === 'function') {
                        table = Arrow.read(uint8Array);
                        method = 'Arrow.read';
                        log('Parsed with Arrow.read');
                    } else {
                        throw new Error('No compatible Arrow parsing method found');
                    }
                    
                    parsedTable = table;
                    parsedData = table.toArray();
                    
                    log(`Table parsed successfully using ${method}`);
                    log(`Rows: ${table.numRows}, Columns: ${table.numCols}`);
                    log(`Schema: ${table.schema.fields.map(f => `${f.name}(${f.type})`).join(', ')}`);
                    log(`Converted to array: ${parsedData.length} rows`);
                    log(`Sample data: ${JSON.stringify(parsedData.slice(0, 2))}`);
                    
                    results.innerHTML = `
                        <div class="success">
                            ✅ File parsed successfully using ${method}!<br>
                            Rows: ${table.numRows}<br>
                            Columns: ${table.numCols}<br>
                            Schema: ${table.schema.fields.map(f => `${f.name}(${f.type})`).join(', ')}<br>
                            Sample data: ${JSON.stringify(parsedData.slice(0, 2))}
                        </div>
                    `;
                    
                    // Enable next test buttons
                    document.getElementById('analysisBtn').disabled = false;
                    document.getElementById('plotBtn').disabled = false;
                    document.getElementById('perfBtn').disabled = false;
                    
                } catch (error) {
                    error(`Parsing failed: ${error.message}`);
                    results.innerHTML = `<div class="error">❌ Parsing failed: ${error.message}</div>`;
                }
            };
            
            reader.onerror = function() {
                error('File reading failed');
                results.innerHTML = '<div class="error">❌ File reading failed</div>';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function testDataAnalysis() {
            if (!parsedData || parsedData.length === 0) {
                document.getElementById('analysisResults').innerHTML = '<div class="error">No data to analyze</div>';
                return;
            }
            
            const results = document.getElementById('analysisResults');
            results.innerHTML = '<p>Analyzing data...</p>';
            
            try {
                log('Starting data analysis...');
                
                const analysis = {
                    totalRows: parsedData.length,
                    fields: Object.keys(parsedData[0]),
                    numericFields: [],
                    stringFields: [],
                    dateFields: [],
                    fieldStats: {}
                };
                
                // Analyze each field
                analysis.fields.forEach(field => {
                    const values = parsedData.map(row => row[field]);
                    const nonNullValues = values.filter(v => v !== null && v !== undefined);
                    
                    if (nonNullValues.length === 0) {
                        analysis.fieldStats[field] = { type: 'empty', count: 0 };
                        return;
                    }
                    
                    const firstValue = nonNullValues[0];
                    const isNumeric = typeof firstValue === 'number' && !isNaN(firstValue);
                    const isDate = firstValue instanceof Date || (typeof firstValue === 'string' && !isNaN(Date.parse(firstValue)));
                    
                    if (isNumeric) {
                        analysis.numericFields.push(field);
                        const stats = {
                            type: 'numeric',
                            count: nonNullValues.length,
                            min: Math.min(...nonNullValues),
                            max: Math.max(...nonNullValues),
                            mean: nonNullValues.reduce((a, b) => a + b, 0) / nonNullValues.length
                        };
                        analysis.fieldStats[field] = stats;
                        log(`Numeric field ${field}: min=${stats.min}, max=${stats.max}, mean=${stats.mean.toFixed(2)}`);
                    } else if (isDate) {
                        analysis.dateFields.push(field);
                        analysis.fieldStats[field] = { type: 'date', count: nonNullValues.length };
                        log(`Date field ${field}: ${nonNullValues.length} values`);
                    } else {
                        analysis.stringFields.push(field);
                        const uniqueValues = new Set(nonNullValues);
                        analysis.fieldStats[field] = { 
                            type: 'string', 
                            count: nonNullValues.length,
                            uniqueCount: uniqueValues.size
                        };
                        log(`String field ${field}: ${nonNullValues.length} values, ${uniqueValues.size} unique`);
                    }
                });
                
                log(`Analysis complete: ${analysis.numericFields.length} numeric, ${analysis.stringFields.length} string, ${analysis.dateFields.length} date fields`);
                
                results.innerHTML = `
                    <div class="success">
                        ✅ Data analysis complete!<br>
                        Total rows: ${analysis.totalRows}<br>
                        Numeric fields: ${analysis.numericFields.join(', ')}<br>
                        String fields: ${analysis.stringFields.join(', ')}<br>
                        Date fields: ${analysis.dateFields.join(', ')}
                    </div>
                `;
                
            } catch (error) {
                error(`Data analysis failed: ${error.message}`);
                results.innerHTML = `<div class="error">❌ Data analysis failed: ${error.message}</div>`;
            }
        }
        
        function testPlotting() {
            if (!parsedData || parsedData.length === 0) {
                document.getElementById('plotResults').innerHTML = '<div class="error">No data to plot</div>';
                return;
            }
            
            const results = document.getElementById('plotResults');
            const plotDiv = document.getElementById('plot');
            
            try {
                log('Creating plots...');
                
                // Find numeric fields for plotting
                const numericFields = Object.keys(parsedData[0]).filter(key => {
                    const val = parsedData[0][key];
                    return typeof val === 'number' && !isNaN(val);
                });
                
                log(`Numeric fields found: ${numericFields.join(', ')}`);
                
                if (numericFields.length < 2) {
                    results.innerHTML = '<div class="warning">⚠️ Need at least 2 numeric fields to create scatter plot</div>';
                    log('Not enough numeric fields for scatter plot');
                    return;
                }
                
                const xField = numericFields[0];
                const yField = numericFields[1];
                
                log(`Creating scatter plot: ${xField} vs ${yField}`);
                
                // Create scatter plot
                const plot = Plot.plot({
                    marks: [
                        Plot.dot(parsedData, {
                            x: xField,
                            y: yField,
                            title: d => `${xField}: ${d[xField]}, ${yField}: ${d[yField]}`
                        })
                    ],
                    width: 600,
                    height: 400,
                    x: { label: xField },
                    y: { label: yField },
                    title: `Scatter Plot: ${xField} vs ${yField}`
                });
                
                plotDiv.innerHTML = '';
                plotDiv.appendChild(plot);
                
                results.innerHTML = `
                    <div class="success">
                        ✅ Plot created successfully!<br>
                        Data points: ${parsedData.length}<br>
                        X-axis: ${xField}<br>
                        Y-axis: ${yField}
                    </div>
                `;
                
                log('Plot created successfully');
                
            } catch (error) {
                error(`Plot creation failed: ${error.message}`);
                results.innerHTML = `<div class="error">❌ Plot creation failed: ${error.message}</div>`;
            }
        }
        
        function testPerformance() {
            if (!parsedData || parsedData.length === 0) {
                document.getElementById('perfResults').innerHTML = '<div class="error">No data for performance test</div>';
                return;
            }
            
            const results = document.getElementById('perfResults');
            results.innerHTML = '<p>Running performance tests...</p>';
            
            try {
                log('Starting performance tests...');
                
                const tests = [];
                
                // Test 1: Array operations
                const start1 = performance.now();
                const sum = parsedData.reduce((acc, row) => {
                    const numericFields = Object.keys(row).filter(key => typeof row[key] === 'number');
                    return acc + numericFields.reduce((sum, field) => sum + (row[field] || 0), 0);
                }, 0);
                const end1 = performance.now();
                tests.push({ name: 'Array operations', time: end1 - start1, result: sum });
                
                // Test 2: Filtering
                const start2 = performance.now();
                const filtered = parsedData.filter(row => {
                    const numericFields = Object.keys(row).filter(key => typeof row[key] === 'number');
                    return numericFields.some(field => row[field] > 0);
                });
                const end2 = performance.now();
                tests.push({ name: 'Filtering', time: end2 - start2, result: filtered.length });
                
                // Test 3: Sorting
                const start3 = performance.now();
                const sorted = [...parsedData].sort((a, b) => {
                    const numericFields = Object.keys(a).filter(key => typeof a[key] === 'number');
                    if (numericFields.length > 0) {
                        return (a[numericFields[0]] || 0) - (b[numericFields[0]] || 0);
                    }
                    return 0;
                });
                const end3 = performance.now();
                tests.push({ name: 'Sorting', time: end3 - start3, result: sorted.length });
                
                log('Performance test results:');
                tests.forEach(test => {
                    log(`${test.name}: ${test.time.toFixed(2)}ms (result: ${test.result})`);
                });
                
                const totalTime = tests.reduce((sum, test) => sum + test.time, 0);
                const avgTime = totalTime / tests.length;
                
                results.innerHTML = `
                    <div class="success">
                        ✅ Performance tests complete!<br>
                        Average time: ${avgTime.toFixed(2)}ms<br>
                        Total time: ${totalTime.toFixed(2)}ms<br>
                        Data size: ${parsedData.length} rows
                    </div>
                `;
                
            } catch (error) {
                error(`Performance test failed: ${error.message}`);
                results.innerHTML = `<div class="error">❌ Performance test failed: ${error.message}</div>`;
            }
        }
        
        // Auto-test libraries on load
        window.addEventListener('load', function() {
            log('Page loaded, testing libraries...');
            testLibraries();
            testArrowAPI();
        });
    </script>
</body>
</html> 