<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow Library Loading Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #output { white-space: pre-wrap; background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <h1>Arrow Library Loading Test</h1>
    
    <div class="test">
        <h2>Library Loading Test</h2>
        <button onclick="testLibraryLoading()">Test Library Loading</button>
        <div id="libraryResults"></div>
    </div>
    
    <div class="test">
        <h2>Arrow API Test</h2>
        <button onclick="testArrowAPI()">Test Arrow API</button>
        <div id="apiResults"></div>
    </div>
    
    <div class="test">
        <h2>Table Creation Test</h2>
        <button onclick="testTableCreation()">Test Table Creation</button>
        <div id="tableResults"></div>
    </div>
    
    <div class="test">
        <h2>File Parsing Test</h2>
        <input type="file" id="fileInput" accept=".arrow" />
        <button onclick="testFileParsing()">Test File Parsing</button>
        <div id="fileResults"></div>
    </div>
    
    <div class="test">
        <h2>Console Output</h2>
        <div id="output"></div>
    </div>

    <!-- Apache Arrow JS -->
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@21.0.0/Arrow.es2015.min.js"></script>
    <!-- Arquero for data manipulation -->
    <script src="https://unpkg.com/arquero@5.3.0/dist/arquero.min.js"></script>
    <!-- Observable Plot for visualization -->
    <script src="https://unpkg.com/@observablehq/plot@0.6.17/dist/plot.umd.min.js"></script>
    <!-- D3 for additional utilities -->
    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>

    <script>
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const outputDiv = document.getElementById('output');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            outputDiv.textContent += 'LOG: ' + args.join(' ') + '\n';
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            outputDiv.textContent += 'ERROR: ' + args.join(' ') + '\n';
        };

        function testLibraryLoading() {
            const results = document.getElementById('libraryResults');
            results.innerHTML = '<p>Testing library loading...</p>';
            
            try {
                const libraries = {
                    'Apache Arrow': typeof Arrow !== 'undefined',
                    'Arquero': typeof aq !== 'undefined',
                    'Observable Plot': typeof Plot !== 'undefined',
                    'D3': typeof d3 !== 'undefined'
                };
                
                const failed = Object.entries(libraries).filter(([name, loaded]) => !loaded);
                
                if (failed.length === 0) {
                    results.innerHTML = '<div class="success">✅ All libraries loaded successfully!</div>';
                    console.log('All libraries loaded:', libraries);
                } else {
                    results.innerHTML = `<div class="error">❌ Failed to load: ${failed.map(([name]) => name).join(', ')}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Library loading test failed: ${error.message}</div>`;
            }
        }

        function testArrowAPI() {
            const results = document.getElementById('apiResults');
            results.innerHTML = '<p>Testing Arrow API...</p>';
            
            try {
                const apiTests = [];
                
                // Test Arrow.Table
                if (typeof Arrow.Table !== 'undefined') {
                    apiTests.push('Arrow.Table ✓');
                } else {
                    apiTests.push('Arrow.Table ✗');
                }
                
                // Test Arrow.Table.from
                if (typeof Arrow.Table.from === 'function') {
                    apiTests.push('Arrow.Table.from ✓');
                } else {
                    apiTests.push('Arrow.Table.from ✗');
                }
                
                // Test Arrow.tableFrom
                if (typeof Arrow.tableFrom === 'function') {
                    apiTests.push('Arrow.tableFrom ✓');
                } else {
                    apiTests.push('Arrow.tableFrom ✗');
                }
                
                // Test Arrow.read
                if (typeof Arrow.read === 'function') {
                    apiTests.push('Arrow.read ✓');
                } else {
                    apiTests.push('Arrow.read ✗');
                }
                
                // Test Arrow.RecordBatchReader
                if (typeof Arrow.RecordBatchReader !== 'undefined') {
                    apiTests.push('Arrow.RecordBatchReader ✓');
                } else {
                    apiTests.push('Arrow.RecordBatchReader ✗');
                }
                
                const failed = apiTests.filter(test => test.includes('✗'));
                
                if (failed.length === 0) {
                    results.innerHTML = '<div class="success">✅ All Arrow API methods available!</div>';
                } else {
                    results.innerHTML = `<div class="error">❌ Missing API methods: ${failed.join(', ')}</div>`;
                }
                
                console.log('Arrow API tests:', apiTests);
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Arrow API test failed: ${error.message}</div>`;
            }
        }

        function testTableCreation() {
            const results = document.getElementById('tableResults');
            results.innerHTML = '<p>Testing table creation...</p>';
            
            try {
                // Create test data
                const testData = [
                    { id: 1, name: 'Alice', value: 10.5 },
                    { id: 2, name: 'Bob', value: 20.3 },
                    { id: 3, name: 'Charlie', value: 15.7 }
                ];
                
                let table;
                let method = '';
                
                // Try different table creation methods
                if (typeof Arrow.Table.from === 'function') {
                    table = Arrow.Table.from(testData);
                    method = 'Arrow.Table.from';
                } else if (typeof Arrow.tableFrom === 'function') {
                    table = Arrow.tableFrom(testData);
                    method = 'Arrow.tableFrom';
                } else if (typeof Arrow.read === 'function') {
                    table = Arrow.read(testData);
                    method = 'Arrow.read';
                } else {
                    throw new Error('No compatible table creation method found');
                }
                
                results.innerHTML = `
                    <div class="success">
                        ✅ Table created successfully using ${method}!<br>
                        Rows: ${table.numRows}<br>
                        Columns: ${table.numCols}<br>
                        Schema: ${table.schema.fields.map(f => f.name).join(', ')}
                    </div>
                `;
                
                console.log('Table created:', { method, rows: table.numRows, cols: table.numCols });
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Table creation failed: ${error.message}</div>`;
            }
        }

        function testFileParsing() {
            const fileInput = document.getElementById('fileInput');
            const results = document.getElementById('fileResults');
            
            if (fileInput.files.length === 0) {
                results.innerHTML = '<div class="error">Please select a file first</div>';
                return;
            }
            
            const file = fileInput.files[0];
            results.innerHTML = `<p>Testing file: ${file.name} (${file.size} bytes)</p>`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                console.log('File loaded, size:', arrayBuffer.byteLength);
                
                try {
                    const uint8Array = new Uint8Array(arrayBuffer);
                    console.log('First 32 bytes:', Array.from(uint8Array.slice(0, 32)));
                    
                    // Try parsing with different methods
                    let table;
                    let method = '';
                    
                    if (typeof Arrow.Table.from === 'function') {
                        table = Arrow.Table.from(uint8Array);
                        method = 'Arrow.Table.from';
                    } else if (typeof Arrow.tableFrom === 'function') {
                        table = Arrow.tableFrom(uint8Array);
                        method = 'Arrow.tableFrom';
                    } else if (typeof Arrow.read === 'function') {
                        table = Arrow.read(uint8Array);
                        method = 'Arrow.read';
                    } else {
                        throw new Error('No compatible Arrow parsing method found');
                    }
                    
                    results.innerHTML += `
                        <div class="success">
                            ✅ File parsed successfully using ${method}!<br>
                            Rows: ${table.numRows}<br>
                            Columns: ${table.numCols}<br>
                            Schema: ${table.schema.fields.map(f => `${f.name}(${f.type})`).join(', ')}
                        </div>
                    `;
                    
                    console.log('File parsed successfully:', { method, rows: table.numRows, cols: table.numCols });
                } catch (error) {
                    console.error('Parsing failed:', error);
                    results.innerHTML += `<div class="error">❌ Parsing failed: ${error.message}</div>`;
                }
            };
            
            reader.onerror = function() {
                results.innerHTML += '<div class="error">❌ File reading failed</div>';
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Auto-test libraries on load
        window.addEventListener('load', function() {
            console.log('Page loaded, testing libraries...');
            testLibraryLoading();
            testArrowAPI();
        });
    </script>
</body>
</html> 