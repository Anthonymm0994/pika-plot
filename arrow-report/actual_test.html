<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actual Arrow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        #plot { width: 100%; height: 400px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Actual Arrow File Test</h1>
    
    <div class="test">
        <h2>Step 1: Load Arrow File</h2>
        <input type="file" id="fileInput" accept=".arrow" />
        <button onclick="loadAndParse()">Load & Parse Arrow File</button>
        <div id="loadResults"></div>
    </div>
    
    <div class="test">
        <h2>Step 2: Create Plot</h2>
        <button onclick="createPlot()" id="plotBtn" disabled>Create Plot</button>
        <div id="plotResults"></div>
        <div id="plot"></div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@21.0.0/Arrow.es2015.min.js"></script>
    <script src="https://unpkg.com/arquero@5.3.0/dist/arquero.min.js"></script>
    <script src="https://unpkg.com/@observablehq/plot@0.6.17/dist/plot.umd.min.js"></script>
    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>

    <script>
        let parsedData = null;
        
        function loadAndParse() {
            const fileInput = document.getElementById('fileInput');
            const results = document.getElementById('loadResults');
            
            if (fileInput.files.length === 0) {
                results.innerHTML = '<div class="error">Please select a file first</div>';
                return;
            }
            
            const file = fileInput.files[0];
            results.innerHTML = `<p>Loading: ${file.name} (${file.size} bytes)</p>`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                console.log('File loaded, size:', arrayBuffer.byteLength);
                
                try {
                    const uint8Array = new Uint8Array(arrayBuffer);
                    console.log('First 32 bytes:', Array.from(uint8Array.slice(0, 32)));
                    
                    // Try to parse the Arrow file
                    let table;
                    if (typeof Arrow.Table !== 'undefined' && typeof Arrow.Table.from === 'function') {
                        table = Arrow.Table.from(uint8Array);
                        console.log('Parsed with Arrow.Table.from');
                    } else if (typeof Arrow.tableFrom === 'function') {
                        table = Arrow.tableFrom(uint8Array);
                        console.log('Parsed with Arrow.tableFrom');
                    } else if (typeof Arrow.read === 'function') {
                        table = Arrow.read(uint8Array);
                        console.log('Parsed with Arrow.read');
                    } else {
                        throw new Error('No compatible Arrow parsing method found');
                    }
                    
                    console.log('Table parsed:', {
                        rows: table.numRows,
                        cols: table.numCols,
                        schema: table.schema.fields.map(f => ({ name: f.name, type: f.type.toString() }))
                    });
                    
                    // Convert to JavaScript objects for plotting
                    parsedData = table.toArray();
                    console.log('Converted to array:', parsedData.length, 'rows');
                    console.log('Sample data:', parsedData.slice(0, 3));
                    
                    results.innerHTML = `
                        <div class="success">
                            ✅ File parsed successfully!<br>
                            Rows: ${table.numRows}<br>
                            Columns: ${table.numCols}<br>
                            Schema: ${table.schema.fields.map(f => f.name).join(', ')}<br>
                            Sample data: ${JSON.stringify(parsedData.slice(0, 2))}
                        </div>
                    `;
                    
                    // Enable plot button
                    document.getElementById('plotBtn').disabled = false;
                    
                } catch (error) {
                    console.error('Parsing failed:', error);
                    results.innerHTML = `<div class="error">❌ Parsing failed: ${error.message}</div>`;
                }
            };
            
            reader.onerror = function() {
                results.innerHTML = '<div class="error">❌ File reading failed</div>';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function createPlot() {
            if (!parsedData || parsedData.length === 0) {
                document.getElementById('plotResults').innerHTML = '<div class="error">No data to plot</div>';
                return;
            }
            
            const results = document.getElementById('plotResults');
            const plotDiv = document.getElementById('plot');
            
            try {
                console.log('Creating plot with data:', parsedData.length, 'rows');
                console.log('First row:', parsedData[0]);
                
                // Find numeric fields for plotting
                const numericFields = Object.keys(parsedData[0]).filter(key => {
                    const val = parsedData[0][key];
                    return typeof val === 'number' && !isNaN(val);
                });
                
                console.log('Numeric fields:', numericFields);
                
                if (numericFields.length < 2) {
                    results.innerHTML = '<div class="error">Need at least 2 numeric fields to plot</div>';
                    return;
                }
                
                const xField = numericFields[0];
                const yField = numericFields[1];
                
                console.log('Using fields:', xField, 'vs', yField);
                
                // Create scatter plot
                const plot = Plot.plot({
                    marks: [
                        Plot.dot(parsedData, {
                            x: xField,
                            y: yField,
                            title: d => `${xField}: ${d[xField]}, ${yField}: ${d[yField]}`
                        })
                    ],
                    width: 600,
                    height: 400,
                    x: { label: xField },
                    y: { label: yField },
                    title: `Scatter Plot: ${xField} vs ${yField}`
                });
                
                plotDiv.innerHTML = '';
                plotDiv.appendChild(plot);
                
                results.innerHTML = `
                    <div class="success">
                        ✅ Plot created successfully!<br>
                        Data points: ${parsedData.length}<br>
                        X-axis: ${xField}<br>
                        Y-axis: ${yField}
                    </div>
                `;
                
            } catch (error) {
                console.error('Plot creation failed:', error);
                results.innerHTML = `<div class="error">❌ Plot creation failed: ${error.message}</div>`;
            }
        }
        
        // Test libraries on load
        window.addEventListener('load', function() {
            console.log('Libraries loaded:', {
                Arrow: typeof Arrow !== 'undefined',
                Arquero: typeof aq !== 'undefined',
                Plot: typeof Plot !== 'undefined',
                D3: typeof d3 !== 'undefined'
            });
        });
    </script>
</body>
</html> 