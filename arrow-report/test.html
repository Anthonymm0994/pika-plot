<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow Data Explorer - Test Page</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Apache Arrow JS -->
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@21.0.0/Arrow.es2015.min.js"></script>
    <!-- Arquero for data manipulation -->
    <script src="https://unpkg.com/arquero@5.3.0/dist/arquero.min.js"></script>
    <!-- Observable Plot for visualization -->
    <script src="https://unpkg.com/@observablehq/plot@0.6.17/dist/plot.umd.min.js"></script>
    <!-- D3 for additional utilities -->
    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .test-button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-results {
            margin-top: 15px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Arrow Data Explorer - Test Suite</h1>
        
        <div class="test-section">
            <h2>Library Loading Tests</h2>
            <button class="test-button" onclick="testLibraryLoading()">Test Library Loading</button>
            <div id="libraryTestResults" class="test-results"></div>
        </div>

        <div class="test-section">
            <h2>Sample Data Generation</h2>
            <button class="test-button" onclick="generateSampleData()">Generate Sample Arrow Data</button>
            <button class="test-button" onclick="generateLargeDataset()">Generate Large Dataset (10K rows)</button>
            <div id="dataGenerationResults" class="test-results"></div>
        </div>

        <div class="test-section">
            <h2>Data Loading Tests</h2>
            <button class="test-button" onclick="testDataLoading()">Test Data Loading</button>
            <button class="test-button" onclick="testTimeSeriesData()">Test Time Series Data</button>
            <div id="dataLoadingResults" class="test-results"></div>
        </div>

        <div class="test-section">
            <h2>Performance Tests</h2>
            <button class="test-button" onclick="testPerformance()">Run Performance Tests</button>
            <div id="performanceResults" class="test-results"></div>
        </div>

        <div class="test-section">
            <h2>Integration Tests</h2>
            <button class="test-button" onclick="testFullIntegration()">Test Full Integration</button>
            <div id="integrationResults" class="test-results"></div>
        </div>
    </div>

    <script src="js/loader.js"></script>
    <script src="js/query.js"></script>
    <script src="js/plot.js"></script>
    <script src="js/ui.js"></script>
    
    <script>
        // Test functions
        function testLibraryLoading() {
            const results = document.getElementById('libraryTestResults');
            results.innerHTML = '<p>Testing library loading...</p>';
            
            try {
                // Test Arrow library
                if (typeof Arrow === 'undefined') {
                    throw new Error('Apache Arrow library not loaded');
                }
                
                // Test Arquero library
                if (typeof aq === 'undefined') {
                    throw new Error('Arquero library not loaded');
                }
                
                // Test Plot library
                if (typeof Plot === 'undefined') {
                    throw new Error('Observable Plot library not loaded');
                }
                
                // Test D3 library
                if (typeof d3 === 'undefined') {
                    throw new Error('D3 library not loaded');
                }
                
                results.innerHTML = '<div class="success">✅ All libraries loaded successfully!</div>';
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Library loading failed: ${error.message}</div>`;
            }
        }

        function generateSampleData() {
            const results = document.getElementById('dataGenerationResults');
            results.innerHTML = '<p>Generating sample data...</p>';
            
            try {
                // Create sample data
                const data = [];
                const now = new Date();
                
                for (let i = 0; i < 100; i++) {
                    data.push({
                        id: i,
                        timestamp: new Date(now.getTime() + i * 60000), // 1 minute intervals
                        value: Math.random() * 100,
                        category: ['A', 'B', 'C'][Math.floor(Math.random() * 3)],
                        temperature: 20 + Math.random() * 30,
                        humidity: Math.random() * 100
                    });
                }
                
                // Convert to Arrow format
                const arrowBuffer = createArrowBuffer(data);
                
                // Create a downloadable file
                const blob = new Blob([arrowBuffer], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sample_data.arrow';
                a.click();
                URL.revokeObjectURL(url);
                
                results.innerHTML = '<div class="success">✅ Sample data generated and downloaded as sample_data.arrow</div>';
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Data generation failed: ${error.message}</div>`;
            }
        }

        function generateLargeDataset() {
            const results = document.getElementById('dataGenerationResults');
            results.innerHTML = '<p>Generating large dataset...</p>';
            
            try {
                // Create large dataset
                const data = [];
                const now = new Date();
                
                for (let i = 0; i < 10000; i++) {
                    data.push({
                        id: i,
                        timestamp: new Date(now.getTime() + i * 60000),
                        value: Math.random() * 1000,
                        category: ['A', 'B', 'C', 'D', 'E'][Math.floor(Math.random() * 5)],
                        temperature: 15 + Math.random() * 40,
                        humidity: Math.random() * 100,
                        pressure: 1000 + Math.random() * 100,
                        wind_speed: Math.random() * 50
                    });
                }
                
                // Convert to Arrow format
                const arrowBuffer = createArrowBuffer(data);
                
                // Create a downloadable file
                const blob = new Blob([arrowBuffer], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'large_dataset.arrow';
                a.click();
                URL.revokeObjectURL(url);
                
                results.innerHTML = '<div class="success">✅ Large dataset generated and downloaded as large_dataset.arrow</div>';
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Large dataset generation failed: ${error.message}</div>`;
            }
        }

        function testDataLoading() {
            const results = document.getElementById('dataLoadingResults');
            results.innerHTML = '<p>Testing data loading...</p>';
            
            try {
                // Create test data
                const testData = [
                    { id: 1, value: 10, category: 'A' },
                    { id: 2, value: 20, category: 'B' },
                    { id: 3, value: 30, category: 'A' }
                ];
                
                const arrowBuffer = createArrowBuffer(testData);
                
                // Test loading with ArrowLoader
                const loader = new ArrowLoader();
                const testFile = new File([arrowBuffer], 'test.arrow', { type: 'application/octet-stream' });
                
                loader.loadArrowFile(testFile).then(result => {
                    results.innerHTML = `
                        <div class="success">
                            ✅ Data loading test successful!<br>
                            Rows: ${result.schema.numRows}<br>
                            Columns: ${result.schema.numCols}<br>
                            Fields: ${result.schema.fields.map(f => f.name).join(', ')}
                        </div>
                    `;
                }).catch(error => {
                    results.innerHTML = `<div class="error">❌ Data loading test failed: ${error.message}</div>`;
                });
                
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Data loading test failed: ${error.message}</div>`;
            }
        }

        function testTimeSeriesData() {
            const results = document.getElementById('dataLoadingResults');
            results.innerHTML = '<p>Testing time series data...</p>';
            
            try {
                // Create time series data
                const timeSeriesData = [];
                const baseTime = new Date('2024-01-01T00:00:00Z');
                
                for (let i = 0; i < 100; i++) {
                    timeSeriesData.push({
                        timestamp: new Date(baseTime.getTime() + i * 3600000), // 1 hour intervals
                        value: Math.sin(i * 0.1) * 50 + 100,
                        temperature: 20 + Math.sin(i * 0.05) * 10,
                        humidity: 50 + Math.cos(i * 0.03) * 20
                    });
                }
                
                const arrowBuffer = createArrowBuffer(timeSeriesData);
                const loader = new ArrowLoader();
                const testFile = new File([arrowBuffer], 'timeseries.arrow', { type: 'application/octet-stream' });
                
                loader.loadArrowFile(testFile).then(result => {
                    results.innerHTML = `
                        <div class="success">
                            ✅ Time series data test successful!<br>
                            Rows: ${result.schema.numRows}<br>
                            Time fields: ${result.schema.fields.filter(f => f.type.includes('Timestamp')).length}<br>
                            Numeric fields: ${result.schema.fields.filter(f => f.type.includes('Float') || f.type.includes('Int')).length}
                        </div>
                    `;
                }).catch(error => {
                    results.innerHTML = `<div class="error">❌ Time series test failed: ${error.message}</div>`;
                });
                
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Time series test failed: ${error.message}</div>`;
            }
        }

        function testPerformance() {
            const results = document.getElementById('performanceResults');
            results.innerHTML = '<p>Running performance tests...</p>';
            
            try {
                const startTime = performance.now();
                
                // Create large dataset for performance testing
                const largeData = [];
                for (let i = 0; i < 5000; i++) {
                    largeData.push({
                        id: i,
                        value: Math.random() * 1000,
                        category: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                        timestamp: new Date(Date.now() + i * 60000)
                    });
                }
                
                const arrowBuffer = createArrowBuffer(largeData);
                const loader = new ArrowLoader();
                const testFile = new File([arrowBuffer], 'performance_test.arrow', { type: 'application/octet-stream' });
                
                loader.loadArrowFile(testFile).then(result => {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    results.innerHTML = `
                        <div class="success">
                            ✅ Performance test completed!<br>
                            Dataset size: ${largeData.length} rows<br>
                            Processing time: ${duration.toFixed(2)}ms<br>
                            Performance: ${(largeData.length / (duration / 1000)).toFixed(0)} rows/second
                        </div>
                    `;
                }).catch(error => {
                    results.innerHTML = `<div class="error">❌ Performance test failed: ${error.message}</div>`;
                });
                
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Performance test failed: ${error.message}</div>`;
            }
        }

        function testFullIntegration() {
            const results = document.getElementById('integrationResults');
            results.innerHTML = '<p>Testing full integration...</p>';
            
            try {
                // Test the complete workflow
                const testData = [
                    { id: 1, value: 10, category: 'A', timestamp: new Date() },
                    { id: 2, value: 20, category: 'B', timestamp: new Date() },
                    { id: 3, value: 30, category: 'A', timestamp: new Date() }
                ];
                
                const arrowBuffer = createArrowBuffer(testData);
                const loader = new ArrowLoader();
                const query = new ArrowQuery();
                const plot = new ArrowPlot();
                
                const testFile = new File([arrowBuffer], 'integration_test.arrow', { type: 'application/octet-stream' });
                
                loader.loadArrowFile(testFile).then(result => {
                    // Test query functionality
                    query.setData(result.table);
                    
                    // Test derived field
                    query.addDerivedField('difference', 'value', 'delta');
                    
                    // Test filtering
                    const filteredData = query.applyFilters(result.table);
                    
                    // Test plotting
                    const plotData = query.getPlotData(filteredData, 'id', 'value', 'category', 'scatter');
                    
                    results.innerHTML = `
                        <div class="success">
                            ✅ Full integration test successful!<br>
                            Data loading: ✅<br>
                            Query processing: ✅<br>
                            Derived fields: ✅<br>
                            Filtering: ✅<br>
                            Plot data preparation: ✅<br>
                            All components working correctly!
                        </div>
                    `;
                }).catch(error => {
                    results.innerHTML = `<div class="error">❌ Integration test failed: ${error.message}</div>`;
                });
                
            } catch (error) {
                results.innerHTML = `<div class="error">❌ Integration test failed: ${error.message}</div>`;
            }
        }

        // Helper function to create Arrow buffer from JavaScript objects
        function createArrowBuffer(data) {
            try {
                // Convert JavaScript objects to Arrow format
                let table;
                if (typeof Arrow.Table !== 'undefined' && typeof Arrow.Table.from === 'function') {
                    table = Arrow.Table.from(data);
                } else if (typeof Arrow.tableFrom !== 'undefined') {
                    table = Arrow.tableFrom(data);
                } else if (typeof Arrow.read !== 'undefined') {
                    table = Arrow.read(data);
                } else {
                    throw new Error('No compatible Arrow table creation method found');
                }
                return table.serialize();
            } catch (error) {
                console.error('Error creating Arrow buffer:', error);
                throw error;
            }
        }

        // Initialize tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Test page loaded. Libraries available:', {
                Arrow: typeof Arrow !== 'undefined',
                Arquero: typeof aq !== 'undefined',
                Plot: typeof Plot !== 'undefined',
                D3: typeof d3 !== 'undefined'
            });
        });
    </script>
</body>
</html> 